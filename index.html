<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kirky Bird</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-TLM-aoW4NrIGALqEHwr4R8aaUKZMjYQ",
  authDomain: "kirkybirdscores.firebaseapp.com",
  projectId: "kirkybirdscores",
  storageBucket: "kirkybirdscores.firebasestorage.app",
  messagingSenderId: "355374076004",
  appId: "1:355374076004:web:4657b6b6a768e97d4c4f71",
  measurementId: "G-K49ZEZSWT2",
  databaseURL: "https://kirkybirdscores-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

/* ---------- GLOBAL SCORE SAVE ---------- */
window.saveGlobalScore = async function (score, username) {
  try {
    const deviceKey = "kirkyBirdDeviceId";
    let deviceId = localStorage.getItem(deviceKey);

    if (!deviceId) {
      deviceId = Math.random().toString(36).slice(2, 10);
      localStorage.setItem(deviceKey, deviceId);
    }

    await set(ref(database, "scores/" + deviceId), {
      username,
      highScore: Number(score),
      updated: Date.now(),
      deviceId
    });
    console.log("Global score saved:", { username, highScore: score });
  } catch (err) {
    console.error("Failed to save global score:", err);
  }
};

/* ---------- SAVE INDIVIDUAL GAME SCORE ---------- */
window.saveGameScore = async function (score, username) {
  try {
    const deviceKey = "kirkyBirdDeviceId";
    let deviceId = localStorage.getItem(deviceKey);

    if (!deviceId) {
      deviceId = Math.random().toString(36).slice(2, 10);
      localStorage.setItem(deviceKey, deviceId);
    }

    // Get the current high score and update if this score is higher
    const scoreRef = ref(database, "scores/" + deviceId);
    const snapshot = await get(scoreRef);
    const currentData = snapshot.val() || {};
    const currentHighScore = currentData.highScore || 0;

    await set(scoreRef, {
      username,
      highScore: Math.max(Number(score), currentHighScore),
      updated: Date.now(),
      deviceId,
      lastScore: Number(score),
      lastScoreTime: Date.now()
    });
    console.log("Game score saved:", { username, score });
  } catch (err) {
    console.error("Failed to save game score:", err);
  }
};

// Sync local storage from database for this device (if present).
window.syncLocalFromDatabase = async function () {
  try {
    const deviceKey = "kirkyBirdDeviceId";
    let deviceId = localStorage.getItem(deviceKey);

    if (!deviceId) return; // nothing to sync

    const scoreRef = ref(database, "scores/" + deviceId);
    const snap = await get(scoreRef);
    if (!snap.exists()) {
      // If admin removed the DB entry, clear local score/username so the game
      // treats this device as not played.
      localStorage.removeItem("kirkyBirdHighScore");
      localStorage.removeItem("kirkyBirdUsername");
      console.log("No DB entry for device; cleared local score and username");
    } else {
      const data = snap.val() || {};
      if (data.username) localStorage.setItem("kirkyBirdUsername", data.username);
      if (data.highScore !== undefined) localStorage.setItem("kirkyBirdHighScore", String(data.highScore));
      console.log("Synced local storage from DB for device", deviceId, data);
    }

    // Live listen for changes to this device's record so admin edits apply immediately
    onValue(scoreRef, s => {
      if (!s.exists()) {
        localStorage.removeItem("kirkyBirdHighScore");
        localStorage.removeItem("kirkyBirdUsername");
        console.log("DB entry removed for device; cleared local storage");
        return;
      }
      const d = s.val();
      if (d.username) localStorage.setItem("kirkyBirdUsername", d.username);
      if (d.highScore !== undefined) localStorage.setItem("kirkyBirdHighScore", String(d.highScore));
      console.log("Live DB update applied to local storage:", d);
    });
  } catch (err) {
    console.error("Failed to sync local data from DB:", err);
  }
};

// perform initial sync before non-module script runs (top-level await allowed in modules)
await window.syncLocalFromDatabase();

window.firebaseReady = true;

</script>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

#gameWrapper {
  position: relative;
  transform: scale(1.15);   /* adjust gameplay size */
  transform-origin: center;
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  background: url("filler.png") no-repeat center center;
  background-size: cover;
}

canvas {
  border: 2px solid black;
  box-shadow: 0 12px 35px rgba(0,0,0,0.4);
  border-radius: 6px;
  z-index: 1;
}

/* FULLSCREEN CUTSCENE STYLES */
#fadeOverlay {
  position: fixed;
  inset: 0;
  background: black;
  opacity: 0;
  pointer-events: none;
  z-index: 9998;
  transition: opacity 3s linear;
}

#fadeOverlay.active {
  opacity: 1;
}

#endingVideo {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  display: none;
  z-index: 9999;
  background: black;
}

#skipButton {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  padding: 10px 15px;
  font-size: 16px;
  background: rgba(255,255,255,0.8);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  display: none;
}

#scoreboardButton {
  position: fixed;
  top: 23%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  padding: 12px 24px;
  font-size: 18px;
  background: rgba(100, 200, 255, 0.9);
  border: 2px solid white;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  font-weight: bold;
}

#audioSlider {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10001;
  width: 300px;
  height: 12px;
  -webkit-appearance: none;
  background: rgba(255,255,255,0.7);
  border-radius: 6px;
  outline: none;
  cursor: pointer;
}

#audioSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  background: #ff0000;
  border-radius: 50%;
  border: 2px solid #fff;
  cursor: pointer;
}

#audioSlider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: #ff0000;
  border-radius: 50%;
  border: 2px solid #fff;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- GAMEPLAY -->
<div id="gameWrapper">
  <canvas id="game" width="400" height="600"></canvas>
</div>

<!-- FULLSCREEN CUTSCENE ELEMENTS -->
<div id="fadeOverlay"></div>
<video id="endingVideo" src="video.mp4" playsinline></video>
<button id="skipButton">Skip Cutscene</button>
<button id="scoreboardButton" style="display: none;">View Scoreboard</button>

<!-- AUDIO CONTROL -->
<input type="range" id="audioSlider" min="0" max="1" step="0.01" value="0.5">
<audio id="music" src="music.mp3" loop></audio>
<audio id="pew" src="pew.mp3" preload="auto"></audio>
<audio id="sound41" src="41sound.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const fadeOverlay = document.getElementById("fadeOverlay");
const endingVideo = document.getElementById("endingVideo");
const skipButton = document.getElementById("skipButton");
const audioSlider = document.getElementById("audioSlider");

const birdImg = new Image(); birdImg.src = "bird.png";
const bgImg = new Image();   bgImg.src = "background.png";
const overImg = new Image(); overImg.src = "over.png";
const img41 = new Image();   img41.src = "41.png";

const music = document.getElementById("music");
const pewSound = document.getElementById("pew");
const sound41 = document.getElementById("sound41");

// ------------------ GAME STATE ------------------
let bird = { x: 80, y: 250, width: 60, height: 45, velocity: 0 };
const gravity = 0.35;
const flapStrength = -7;

let pipes = [];
const pipeWidth = 60;
const gap = 180;

let frame = 0;
let score = 0;
let gameStarted = false;
let gameOver = false;
let endingTriggered = false;
let cutscenePlaying = false;
let adminMode = false;
let targetGapY = null;
let timeScale = 1;

// ------------------ CHEAT CODES ------------------
let typedSequence = [];
const adminWord = "KIRK";
let cheatSequence = [];
const cheatCodes = { "67": 66, "41": 41 };

// ------------------ 41 IMAGE ------------------
let img41X = canvas.width;
let img41Active = false;
let sound41Played = false;

// ------------------ SCOREBOARD ------------------
let highScore = Number(localStorage.getItem("kirkyBirdHighScore")) || 0; 
let username = localStorage.getItem("kirkyBirdUsername") || "Player"; 

// ------------------ SPEED --------------------
let baseSpeed = 1.8;
let speedMultiplier = 0;
const maxSpeedIncrease = 2.2;     // max extra speed
const speedRampRate = 0.0006;     // how fast it ramps up


// ------------------ CONTROLS ------------------
document.addEventListener("keydown", e => {
  const key = e.key.toUpperCase();
  if (key === " ") {
    if (gameOver) restartGame();
    else handleInput();
  }

  typedSequence.push(key);
  if (typedSequence.slice(-adminWord.length).join("") === adminWord) {
    adminMode = !adminMode;
    timeScale = adminMode ? 2.5 : 1;
    targetGapY = null;
    typedSequence = [];
  }

  if (adminMode && "0123456789".includes(e.key)) {
    cheatSequence.push(e.key);
    for (const code in cheatCodes) {
      if (cheatSequence.slice(-code.length).join("") === code) {
        score = cheatCodes[code];
        cheatSequence = [];
        break;
      }
    }
  }
});

document.addEventListener("click", () => {
  if (gameOver) restartGame();
  else handleInput();
});

function handleInput() {
  if (cutscenePlaying) return;
  if (!gameStarted) {
    gameStarted = true;
    music.volume = audioSlider.value;
    endingVideo.volume = audioSlider.value;
    music.play().catch(() => {});
  }
  if (!gameOver && !adminMode) bird.velocity = flapStrength;
}

// ------------------ PIPE GENERATION ------------------
function createPipe() {
  const topHeight = Math.random() * 220 + 60;
  pipes.push({ x: canvas.width, top: topHeight, bottom: canvas.height - topHeight - gap, passed: false });
}

// ------------------ CUTSCENE ------------------
function triggerEnding() {
  if (endingTriggered) return;
  endingTriggered = true;
  cutscenePlaying = true;
  fadeOverlay.classList.add("active");
  skipButton.style.display = "block";

  const fadeInterval = setInterval(() => {
    if (music.volume > 0.02) music.volume -= 0.02;
    else {
      music.pause();
      clearInterval(fadeInterval);
    }
  }, 100);

  setTimeout(() => {
    endingVideo.style.display = "block";
    endingVideo.volume = audioSlider.value;
    endingVideo.play().catch(() => {});
  }, 3000);
}

skipButton.addEventListener("click", () => {
  if (!cutscenePlaying) return;

  endingVideo.pause();
  endingVideo.currentTime = 0;
  endingVideo.style.display = "none";

  skipButton.style.display = "none";
  fadeOverlay.classList.remove("active");
  cutscenePlaying = false;

  music.volume = audioSlider.value;
  music.play().catch(() => {});
});

endingVideo.addEventListener("ended", () => {
  endingVideo.style.display = "none";
  skipButton.style.display = "none";
  endingVideo.currentTime = 0;

  fadeOverlay.classList.remove("active");
  cutscenePlaying = false;

  music.volume = audioSlider.value;
  music.play().catch(() => {});
});

// ------------------ AUDIO SLIDER ------------------
audioSlider.addEventListener("input", () => {
  music.volume = audioSlider.value;
  endingVideo.volume = audioSlider.value;
  sound41.volume = audioSlider.value;
});

// ------------------ UPDATE ------------------
function update() {
  if (!gameStarted || cutscenePlaying || gameOver) return;

  frame += timeScale;

  speedMultiplier = Math.min(
  speedMultiplier + speedRampRate * timeScale,
  maxSpeedIncrease
);

  // Admin auto-move
  if (adminMode && targetGapY !== null) {
    const centerBird = bird.y + bird.height / 2;
    bird.y += (targetGapY - centerBird) * 0.15 * timeScale;
    bird.velocity = 0;
  } else {
    bird.velocity += gravity * timeScale;
    bird.y += bird.velocity * timeScale;
  }

  // CREATE PIPES
  if (frame % 95 < timeScale) createPipe();

  for (let pipe of pipes) {
    // slowly increase difficulty with score
    pipe.x -= (baseSpeed + speedMultiplier) * timeScale;

    if (!pipe.passed && pipe.x + pipeWidth < bird.x) {
      pipe.passed = true;
      score++;
      if (score === 67) triggerEnding();
      if (adminMode) targetGapY = pipe.top + gap / 2;
    }

    if (!adminMode && checkCollision(pipe)) triggerDeath();
  }

  if (!adminMode && (bird.y < 0 || bird.y + bird.height > canvas.height))
    triggerDeath();

  // Activate 41 image
  if (score >= 41) {
    img41Active = true;
    if (!sound41Played) {
      sound41.volume = audioSlider.value;
      sound41.play().catch(() => {});
      sound41Played = true;
    }
  }
  if (img41Active) img41X -= 20;
}

// ------------------ COLLISION ------------------
function checkCollision(pipe) {
  const hitbox = {
    x: bird.x + bird.width * 0.05,
    y: bird.y + bird.height * 0.05,
    width: bird.width * 0.9,
    height: bird.height * 0.9
  };

  return hitbox.x < pipe.x + pipeWidth &&
         hitbox.x + hitbox.width > pipe.x &&
         (hitbox.y < pipe.top ||
          hitbox.y + hitbox.height > canvas.height - pipe.bottom);
}

// ------------------ GAME OVER ------------------
function triggerDeath() {
  if (gameOver) return;
  gameOver = true;

  // SAVE LOCAL HIGH SCORE
  if (score > highScore) {
    highScore = score;
    localStorage.setItem("kirkyBirdHighScore", highScore);
    
    // SAVE GLOBAL HIGH SCORE
    if (window.saveGlobalScore) {
      saveGlobalScore(highScore, username).catch(e => console.error("Save failed:", e));
    }
  } else {
    // SAVE CURRENT GAME SCORE GLOBALLY (even if not a personal high score)
    if (window.saveGameScore) {
      saveGameScore(score, username).catch(e => console.error("Save failed:", e));
    }
  }

  document.getElementById("scoreboardButton").style.display = "block";

  music.pause();
  pewSound.play().catch(() => {});
}

// ------------------ SCOREBOARD BUTTON ------------------
document.getElementById("scoreboardButton").addEventListener("click", () => {
  window.location.href = "scoreboard.html";
});

// ------------------ RESTART ------------------
function restartGame() {
  bird = { x: 80, y: 250, width: 60, height: 45, velocity: 0 };
  pipes = [];
  frame = 0;
  score = 0;
  gameOver = false;
  gameStarted = true;
  endingTriggered = false;
  cutscenePlaying = false;

  img41X = canvas.width;
  img41Active = false;
  sound41Played = false;

  speedMultiplier = 0;

  document.getElementById("scoreboardButton").style.display = "none";

  music.currentTime = 0;
  music.volume = audioSlider.value;
  music.play().catch(() => {});
}

// ------------------ DRAW ------------------
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

  // Re-sync username/highScore from localStorage so admin edits show up immediately
  try {
    const lsUser = localStorage.getItem("kirkyBirdUsername");
    if (lsUser) username = lsUser;
    const lsHigh = Number(localStorage.getItem("kirkyBirdHighScore"));
    if (!isNaN(lsHigh) && lsHigh >= 0) highScore = lsHigh;
  } catch (e) {
    // ignore
  }
  if (img41Active) ctx.drawImage(img41, img41X, 0, img41.width, canvas.height);

  if (!gameOver) {
    ctx.save();
    ctx.translate(bird.x + bird.width/2, bird.y + bird.height/2);
    ctx.rotate(bird.velocity * 0.05);
    ctx.drawImage(birdImg,-bird.width/2,-bird.height/2,bird.width,bird.height);
    ctx.restore();

    ctx.fillStyle = "green";
    for (let p of pipes) {
      ctx.fillRect(p.x,0,pipeWidth,p.top);
      ctx.fillRect(p.x,canvas.height - p.bottom,pipeWidth,p.bottom);
    }
  } else {
    const overHeight = canvas.height / 2;
    ctx.drawImage(overImg, 0, (canvas.height - overHeight)/2, canvas.width, overHeight);

    ctx.fillStyle = "white";
    ctx.font = "24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("Score: " + score, canvas.width/2, 50);
    ctx.fillText("High Score: " + highScore, canvas.width/2, 85);
    ctx.fillText("Click or Press SPACE to Restart", canvas.width/2, 550);
    ctx.textAlign = "start";
  }

   ctx.fillStyle = "white";
   ctx.font = "24px Arial";
   ctx.fillText("Score: " + score, 10, 30);
   ctx.font = "18px Arial";
   ctx.fillText("Best: " + highScore, 10, 55);

   ctx.fillStyle = "white";
   ctx.font = "16px Arial";
   ctx.fillText("User: " + username, 10, 80); 

  if (adminMode) {
    ctx.fillStyle = "red";
    ctx.font = "20px Arial";
    ctx.textAlign = "right";
    ctx.fillText("ADMIN MODE", canvas.width - 10, 30);
    ctx.textAlign = "start";
  }
}

// ------------------ LOOP ------------------
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
