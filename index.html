<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kirky Bird</title>

<style>
body {
  margin: 0;
  position: relative;
  background-image: url("filler.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: Arial, sans-serif;
}

body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.25);
  z-index: 0;
}

canvas {
  position: relative;
  z-index: 1;
  border: 2px solid black;
  box-shadow: 0 12px 35px rgba(0,0,0,0.4);
  border-radius: 6px;
}
</style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<audio id="music" src="music.mp3" loop></audio>
<audio id="pew" src="pew.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Images
const birdImg = new Image();
birdImg.src = "bird.png";

const bgImg = new Image();
bgImg.src = "background.png";

const overImg = new Image();
overImg.src = "over.png";

// Audio
const music = document.getElementById("music");
const pewSound = document.getElementById("pew");

// Bird
let bird = {
  x: 80,
  y: 250,
  width: 60,
  height: 45,
  velocity: 0
};

const gravity = 0.4;
const flapStrength = -8;

// Pipes
let pipes = [];
const pipeWidth = 60;
const gap = 180;

// Game state
let frame = 0;
let score = 0;
let gameStarted = false;
let gameOver = false;
let adminMode = false;

// Admin targeting
let targetGapY = null;

// Speed scaling
let timeScale = 1;

// Controls
document.addEventListener("keydown", e => {
  if (e.code === "Space") {
    e.preventDefault();
    handleInput();
  }

  if (e.code === "KeyQ") {
    adminMode = !adminMode;
    timeScale = adminMode ? 2.5 : 1;
    targetGapY = null;
    console.log("ADMIN MODE:", adminMode);
  }
});

document.addEventListener("click", handleInput);

function handleInput() {
  if (!gameStarted) {
    gameStarted = true;
    music.volume = 0.5;
    music.play().catch(() => {});
  }

  if (!gameOver && !adminMode) {
    bird.velocity = flapStrength;
  } else if (gameOver) {
    resetGame();
  }
}

function resetGame() {
  bird.y = 250;
  bird.velocity = 0;
  pipes = [];
  frame = 0;
  score = 0;
  gameOver = false;
  targetGapY = null;

  music.currentTime = 0;
  music.play().catch(() => {});
}

function createPipe() {
  const topHeight = Math.random() * 220 + 60;
  pipes.push({
    x: canvas.width,
    top: topHeight,
    bottom: canvas.height - topHeight - gap,
    passed: false
  });
}

function update() {
  if (!gameStarted || gameOver) return;

  frame += timeScale;

  // Admin autopilot (linear targeting)
  if (adminMode && targetGapY !== null) {
    const centerBird = bird.y + bird.height / 2;
    const diff = targetGapY - centerBird;
    bird.y += diff * 0.15 * timeScale;
    bird.velocity = 0;
  } else {
    bird.velocity += gravity * timeScale;
    bird.y += bird.velocity * timeScale;
  }

  if (frame % 90 < timeScale) createPipe();

  for (let pipe of pipes) {
    pipe.x -= 2 * timeScale;

    if (!pipe.passed && pipe.x + pipeWidth < bird.x) {
      pipe.passed = true;
      score++;

      if (adminMode) {
        targetGapY = pipe.top + gap / 2;
      }
    }

    if (!adminMode && checkCollision(pipe)) {
      triggerDeath();
      return;
    }
  }

  if (!adminMode && (bird.y < 0 || bird.y + bird.height > canvas.height)) {
    triggerDeath();
  }
}

function checkCollision(pipe) {
  return (
    bird.x < pipe.x + pipeWidth &&
    bird.x + bird.width > pipe.x &&
    (bird.y < pipe.top ||
     bird.y + bird.height > canvas.height - pipe.bottom)
  );
}

function triggerDeath() {
  if (gameOver) return;

  gameOver = true;
  music.pause();
  music.currentTime = 0;

  pewSound.currentTime = 0;
  pewSound.play().catch(() => {});
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

  // Bird
  ctx.save();
  ctx.translate(bird.x + bird.width/2, bird.y + bird.height/2);
  ctx.rotate(bird.velocity * 0.05);
  ctx.drawImage(birdImg, -bird.width/2, -bird.height/2, bird.width, bird.height);
  ctx.restore();

  // Pipes
  ctx.fillStyle = "green";
  for (let pipe of pipes) {
    ctx.fillRect(pipe.x, 0, pipeWidth, pipe.top);
    ctx.fillRect(pipe.x, canvas.height - pipe.bottom, pipeWidth, pipe.bottom);
  }

  // Score
  ctx.fillStyle = "black";
  ctx.font = "24px Arial";
  ctx.fillText("Score: " + score, 10, 30);

  if (adminMode) {
    ctx.fillStyle = "red";
    ctx.font = "16px Arial";
    ctx.fillText("ADMIN MODE", 260, 30);
  }

  if (!gameStarted) {
    ctx.font = "26px Arial";
    ctx.fillText("Press SPACE or Click to Start", 30, 300);
  }

  if (gameOver) {
    ctx.drawImage(overImg, 75, 250, 250, 100);
    ctx.font = "18px Arial";
    ctx.fillText("Press SPACE or Click to Restart", 60, 370);
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
