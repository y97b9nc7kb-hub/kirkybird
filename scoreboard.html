<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kirky Bird ‚Äì Global Scoreboard</title>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: url("filler.png") no-repeat center center;
  background-size: cover;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

#board {
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 30px;
  border-radius: 12px;
  width: 420px;
  max-height: 80vh;
  overflow-y: auto;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
}

.score {
  display: grid;
  grid-template-columns: 50px 1fr 80px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.rank {
  color: gold;
}

#backButton {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 10000;
  padding: 10px 15px;
  font-size: 16px;
  background: rgba(100, 200, 255, 0.9);
  border: 2px solid white;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  font-weight: bold;
}
</style>
</head>

<body>

<div id="board">
  <h1>üèÜ Global Scoreboard</h1>
  <div id="scores">Loading‚Ä¶</div>
</div>

<button id="backButton">‚Üê Back to Game</button>

<script type="module">
/* ---------- FIREBASE ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getDatabase,
  ref,
  get,
  set
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-TLM-aoW4NrIGALqEHwr4R8aaUKZMjYQ",
  authDomain: "kirkybirdscores.firebaseapp.com",
  projectId: "kirkybirdscores",
  storageBucket: "kirkybirdscores.firebasestorage.app",
  messagingSenderId: "355374076004",
  appId: "1:355374076004:web:4657b6b6a768e97d4c4f71",
  measurementId: "G-K49ZEZSWT2",
  databaseURL: "https://kirkybirdscores-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

const scoresDiv = document.getElementById("scores");
const USERNAME_KEY = "kirkyBirdUsername";

/* ---------- SYNC LOCAL HIGH SCORE TO FIRESTORE ---------- */
(async () => {
  let username = localStorage.getItem(USERNAME_KEY);
  if (!username) {
    username = "Player";
    localStorage.setItem(USERNAME_KEY, username);
  }

  const deviceKey = "kirkyBirdDeviceId";
  let deviceId = localStorage.getItem(deviceKey);
  if (!deviceId) {
    deviceId = Math.random().toString(36).slice(2, 10);
    localStorage.setItem(deviceKey, deviceId);
  }

  const localHighScore = Number(localStorage.getItem("kirkyBirdHighScore")) || 0;

  if (localHighScore > 0) {
    try {
      // Use per-device path so multiple devices (and players) are listed
      await set(ref(database, "scores/" + deviceId), {
        username,
        highScore: Number(localHighScore),
        updated: Date.now(),
        deviceId
      });
    } catch (err) {
      console.error("Sync failed:", err);
    }
  }
})();

/* ---------- LOAD SCORES ---------- */
async function loadScores() {
  try {
    console.log("Loading scores from Realtime Database...");
    
    // Load all scores from the database
    const snapshot = await get(ref(database, "scores"));
    
    scoresDiv.innerHTML = "";

    if (!snapshot.exists()) {
      scoresDiv.textContent = "No scores yet. Play a game to get started!";
      console.log("No scores found in database");
      return;
    }

    const scoresData = snapshot.val();
    const rows = [];

    // Convert object to array and filter valid scores
    for (const deviceId in scoresData) {
      const data = scoresData[deviceId];
      if (data && data.highScore !== undefined) {
        rows.push({
          username: data.username || "Player",
          score: Number(data.highScore) || 0,
          updated: data.updated || 0
        });
      }
    }

    // Sort by score desc, then by most recently updated
    rows.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return (b.updated || 0) - (a.updated || 0);
    });

    console.log("Displaying " + rows.length + " scores on scoreboard");

    let rank = 1;
    for (const data of rows) {
      const row = document.createElement("div");
      row.className = "score";
      row.innerHTML = `
        <span class="rank">#${rank}</span>
        <span>${escapeHtml(String(data.username))}</span>
        <span>${data.score}</span>
      `;
      scoresDiv.appendChild(row);
      rank++;
    }

  } catch (err) {
    console.error("Failed to load scores:", err);
    console.error("Error code:", err.code);
    console.error("Error message:", err.message);
    scoresDiv.textContent = "‚ö†Ô∏è Failed to load scores: " + (err.message || "Unknown error");
  }
}

// small helper to avoid injecting raw HTML from database
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, function(m) { return ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  })[m]; });
}

// Initialize database and load scores
(async () => {
  try {
    await loadScores();
  } catch (err) {
    console.error("Critical error loading scores:", err);
    scoresDiv.textContent = "‚ö†Ô∏è Database connection failed";
  }
})();

/* ---------- BACK BUTTON ---------- */
document.getElementById("backButton").addEventListener("click", () => {
  sessionStorage.setItem("fromMain", "yes");
  window.location.href = "index.html";
});
</script>

</body>
</html>
